<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Panorama Viewer</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
		<style>
			html, body {
				background-color: #000;
				color: #fff;
				margin: 0px;
				padding: 0px;
				overflow: hidden;
			}

		</style>
	</head>
	<body>
		<script src="js/deps/three.min.js"></script>
		<script src="js/deps/VRControls.js"></script>
		<script src="js/deps/VREffect.js"></script>
    <script src="js/deps/webvr-polyfill.js"></script>
    <script src="js/deps/webvr-manager.js"></script>
    <script src="js/photosphere-loader.js"></script>

		<script>

		// define all the different panoramas we will use.
		var panos = [
      {
				"title": "Tahoe",
				"details": "Tahoe",
				"owner": "Boris Smus",
				"overlay": "puydesancy-overlay.png",
				"image": "tahoe-beach.jpg",
				"audio": "235428__allanz10d__calm-ocean-breeze-simulation.ogg",
				"source": "http://bit.ly/1xk9Vk1",
				"license": "Creative Commons"
			},
      {
				"title": "Alcatraz",
				"details": "Alcatraz",
				"owner": "Boris Smus",
				"image": "alcatraz-wei-wei-4096.jpg",
				"audio": "235428__allanz10d__calm-ocean-breeze-simulation.ogg",
				"source": "http://bit.ly/1xk9Vk1",
				"license": "Creative Commons"
			},
			{
				"title": "En route pour le Puy de Sancy",
				"details": "Equirectangular panorama built from 10 pictures, shot handheld.",
				"owner": " Alexandre Duret-Lutz",
				"overlay": "puydesancy-overlay.png",
				"image": "puydesancy.jpg",
				"audio": "235428__allanz10d__calm-ocean-breeze-simulation.ogg",
				"source": "http://bit.ly/1xk9Vk1",
				"license": "Creative Commons"
			},
			{
				"title": "Mus√©e du Louvre",
				"details": "Equirectangular panorama built from 8 pictures.",
				"owner": " Alexandre Duret-Lutz",
				"overlay": "louvre-overlay.png",
				"image": "louvre.jpg",
				"audio": "235428__allanz10d__calm-ocean-breeze-simulation.ogg",
				"source": "https://www.flickr.com/photos/gadl/406108908",
				"license": "Creative Commons"
			},
			{
				"title": "Sunrise on Tintamarre",
				"details": "Equirectangular panorama built from 8 pictures.",
				"owner": " Alexandre Duret-Lutz",
				"overlay": "tintamarre-overlay.png",
				"image": "tintamarre.jpg",
				"audio": "235428__allanz10d__calm-ocean-breeze-simulation.ogg",
				"source": "g",
				"license": "Creative Commons"
			}
		];


		var counter = 0;

		var renderer = new THREE.WebGLRenderer({ antialias: true });
		renderer.setClearColor( 0x000000 );
    renderer.setPixelRatio(window.devicePixelRatio);

		document.body.appendChild( renderer.domElement );

		var	scene = new THREE.Scene();

		var	camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 10000 );

		// Effect and Controls for VR
		var effect = new THREE.VREffect( renderer );
		var controls = new THREE.VRControls( camera );

    // Create a VR manager helper to enter and exit VR mode.
    var vrmgr = new WebVRManager(effect);

    effect.setSize( window.innerWidth, window.innerHeight );

		function loadPano() {
			var src = 'images/' + panos[counter].image;
      pano.material.map = THREE.ImageUtils.loadTexture(src, THREE.UVMapping, null);

      var loader = new PhotosphereLoader();
      loader.load(src);
		};

    // panorma mesh
		var geometry = new THREE.SphereGeometry( 1000, 60, 60 );
		geometry.applyMatrix( new THREE.Matrix4().makeScale( -1, 1, 1 ) );

		var material = new THREE.MeshBasicMaterial({
			transparent: true,
			map: THREE.ImageUtils.loadTexture(
				'images/background.jpg', // Placeholder texture.
				THREE.UVMapping,
				loadPano
			)
		});

		var pano = new THREE.Mesh( geometry, material );
		pano.renderDepth = 2;

		scene.add(pano);


		function onkey( event ) {
			if ( event.keyCode == '80' ) { // 'P' key.
        counter = mod(counter - 1, panos.length);
				loadPano();
			} else if ( event.keyCode == '78' ) { // 'N' key
        counter = mod(counter + 1, panos.length);
				loadPano();
			}

			event.stopPropagation();

		};

    // From http://goo.gl/IGWTid
    function mod(a, b) {
        return ((a%b)+b)%b;
    }

    function onWindowResize() {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			effect.setSize( window.innerWidth, window.innerHeight );
		}

		// bind events.
		window.addEventListener('resize', onWindowResize, false );
		window.addEventListener("keydown", onkey, true);


		function animate() {
      controls.update();

      // Render the scene through the VREffect, but only if it's in VR mode.
      if (vrmgr.isVRMode()) {
        effect.render(scene, camera);
      } else {
        renderer.render(scene, camera);
      }
			requestAnimationFrame( animate );
		}

		// kick off animation
		animate();

		</script>

	</body>
</html>
